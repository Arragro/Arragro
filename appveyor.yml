-
  branches:
    only:
      - master
  version: 1.0.0.{build}
  configuration: Release
  platform: Any CPU
  image: Visual Studio 2015
  cache:
  - src\packages
  services:
    - mssql2014
  nuget:
    account_feed: false
    project_feed: false
  assembly_info:
    patch: true
    file: AssemblyInfo.*
    assembly_version: "{version}"
    assembly_file_version: "{version}"
    assembly_informational_version: "{version}"
  before_build:
  - ps: >-
      nuget sources update -Name nuget.org -Source https://api.nuget.org/v3/index.json;

      nuget restore src;

      nuget install redis-64 -excludeversion;

      redis-64\tools\redis-server.exe --service-install;

      redis-64\tools\redis-server.exe --service-start;
  build:
    publish_nuget: true
    publish_nuget_symbols: true
    include_nuget_references: true
    verbosity: minimal
  deploy:
  - provider: NuGet
    server: https://www.nuget.org/
    api_key:
      secure: F0ZPbEej7MlPRYAb43jRKMZdVDCWLEhfsgmx4o3YTSdcTKIGbOO92NL2LlHcjY1V
    on:
      branch: master
  notifications:
  - provider: Slack
    auth_token:
      secure: ykFbdC7lkZWbEgA8/5cQo3c2+ISttLd1AvhAiXyJqd2eaCdR8p32kE2aHlTxmwFU
    channel: github
    on_build_success: true
    on_build_failure: true
    on_build_status_changed: true

# Test config
-
  branches:
    only:
      - test
  version: 1.0.0.{build}-beta
  configuration: Release
  platform: Any CPU
  image: Visual Studio 2015
  services:
    - mssql2014
  nuget:
    account_feed: false
    project_feed: false
  assembly_info:
    patch: true
    file: AssemblyInfo.*
    assembly_version: "{version}"
    assembly_file_version: "{version}"
    assembly_informational_version: "{version}"
  before_build:
  - ps: >-
      nuget sources update -Name nuget.org -Source https://api.nuget.org/v3/index.json;

      nuget restore src;

      nuget install redis-64 -excludeversion;

      redis-64\tools\redis-server.exe --service-install;

      redis-64\tools\redis-server.exe --service-start;
  build:
    publish_nuget: true
    publish_nuget_symbols: true
    include_nuget_references: true
    verbosity: minimal
  deploy:
  - provider: NuGet
    server: https://www.nuget.org/
    api_key:
      secure: F0ZPbEej7MlPRYAb43jRKMZdVDCWLEhfsgmx4o3YTSdcTKIGbOO92NL2LlHcjY1V
    on:
      branch: master
  notifications:
  - provider: Slack
    auth_token:
      secure: ykFbdC7lkZWbEgA8/5cQo3c2+ISttLd1AvhAiXyJqd2eaCdR8p32kE2aHlTxmwFU
    channel: github
    on_build_success: true
    on_build_failure: true
    on_build_status_changed: true


# Dev config
-
  branches:
    only:
      - /[Dd]ev/
  version: 2.0.{build}-alpha
  configuration: Release
  platform: Any CPU
  image: Previous Visual Studio 2017
  services:
    - mssql2014
  nuget:
    account_feed: false
    project_feed: false
    disable_publish_on_pr: true
  assembly_info:
    patch: true
    file: AssemblyInfo.*
    assembly_version: "{version}"
    assembly_file_version: "{version}"
    assembly_informational_version: "{version}"
  environment:
    # Don't report back to the mothership
    DOTNET_CLI_TELEMETRY_OPTOUT: 1
  init:
  - ps: $Env:LABEL = "alpha-build" + $Env:APPVEYOR_BUILD_NUMBER
  before_build:
  - ps: >-
      $Env:LABEL

      nuget sources update -Name nuget.org -Source https://api.nuget.org/v3/index.json;

      nuget restore src;

      appveyor-retry dotnet restore -v Minimal;

      nuget install redis-64 -excludeversion;

      redis-64\tools\redis-server.exe --service-install;

      redis-64\tools\redis-server.exe --service-start;
  build_script:
  - dotnet build "src\Arragro.Common" -c %CONFIGURATION% --no-dependencies --version-suffix %LABEL%
  - dotnet build "src\Arragro.EntityFrameworkCore" -c %CONFIGURATION% --no-dependencies --version-suffix %LABEL%
  after_build:
    - dotnet pack "src\Arragro.Common" -c %CONFIGURATION% --no-build --version-suffix %LABEL% -o %APPVEYOR_BUILD_FOLDER%\artifacts
    - dotnet pack "src\Arragro.EntityFrameworkCore" -c %CONFIGURATION% --no-build --version-suffix %LABEL% -o %APPVEYOR_BUILD_FOLDER%\artifacts
  test_script:
  - dotnet test "tests\Arragro.Common.Tests\Arragro.Common.Tests.csproj" -c %CONFIGURATION%
  - dotnet test "tests\Arragro.EntityFrameworkCore.IntegrationTests\Arragro.EntityFrameworkCore.IntegrationTests.csproj" -c %CONFIGURATION%
  build:
    publish_nuget: true
    publish_nuget_symbols: true
    include_nuget_references: true
    verbosity: minimal
  test: on
  artifacts:  
    - path: .\artifacts\**\*.nupkg
      name: NuGet
  deploy:
  - provider: NuGet
    api_key:
      secure: F0ZPbEej7MlPRYAb43jRKMZdVDCWLEhfsgmx4o3YTSdcTKIGbOO92NL2LlHcjY1V
    on:
      branch: dev
  notifications:
  - provider: Slack
    auth_token:
      secure: ykFbdC7lkZWbEgA8/5cQo3c2+ISttLd1AvhAiXyJqd2eaCdR8p32kE2aHlTxmwFU
    channel: github
    on_build_success: true
    on_build_failure: true
    on_build_status_changed: true